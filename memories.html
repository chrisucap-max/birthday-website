<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåü Memories Gallery</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --brand:#ff4081;
      --brand2:#6c63ff;
      --glass: rgba(255,255,255,.75);
      --deep: rgba(0,0,0,.5);
    }

    body{
      background:
        radial-gradient(1200px 600px at 10% -10%, #ffe0ef 0%, transparent 50%),
        radial-gradient(1200px 600px at 90% 110%, #dfe3ff 0%, transparent 50%),
        #faf7fb;
    }

    /* Fancy section card */
    .deck{
      max-width: 1080px; margin: 18px auto; padding: 18px;
      background: var(--glass);
      border: 1px solid rgba(255,255,255,.6);
      border-radius: 22px;
      box-shadow: 0 10px 30px rgba(71, 34, 74, .08);
      backdrop-filter: blur(8px);
    }

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:12px 0}
    .btn{
      background: var(--brand);
      color:#fff;border:none;padding:10px 14px;border-radius:999px;
      font-weight:700;cursor:pointer;transition: transform .08s ease, box-shadow .2s ease;
      box-shadow: 0 4px 14px rgba(255,64,129,.25)
    }
    .btn:hover{transform: translateY(-1px); box-shadow:0 6px 18px rgba(255,64,129,.35)}
    .btn:active{transform: translateY(0)}
    .btn.secondary{background: var(--brand2); box-shadow:0 4px 14px rgba(108,99,255,.25)}
    .btn.ghost{background: #fff; color:#222; border:2px solid #eee}

    .meta{color:#666;font-size:12px;text-align:center;margin:6px 0}

    /* Slideshow frame */
    .slideshow{
      position:relative; overflow:hidden; border-radius:18px;
      background:#000; aspect-ratio:16/9;
      box-shadow: 0 16px 36px rgba(19,16,34,.22);
    }
    @media (max-width:680px){ .slideshow{ aspect-ratio:4/3 } }

    .slide-img{
      width:100%;height:100%;object-fit:cover;display:block;
      transform-origin: center center;
      animation: kenburns 12s ease-in-out infinite;
      opacity:0; transition: opacity .5s ease;
    }
    .slide-img.show{ opacity:1 }
    @keyframes kenburns{
      0%{ transform: scale(1.08) translate3d(0,0,0) }
      50%{ transform: scale(1.12) translate3d(2%, -2%, 0) }
      100%{ transform: scale(1.08) translate3d(0,0,0) }
    }

    /* Overlay controls */
    .overlay{
      position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:center;
      pointer-events:none;
      background: linear-gradient(to top, rgba(0,0,0,.45), rgba(0,0,0,0) 55%);
    }
    .overlay .bar{
      width:100%; padding:10px; display:flex; align-items:center; justify-content:space-between; gap:8px;
      pointer-events:auto;
    }
    .chip{
      background: rgba(255,255,255,.9); color:#222; border-radius:999px; padding:6px 10px; font-weight:700; font-size:12px;
      display:flex; align-items:center; gap:8px;
    }
    .caption{
      position:absolute; left:12px; bottom:56px; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.6);
      font-weight:700; letter-spacing:.2px; background: rgba(0,0,0,.25); padding:6px 10px; border-radius:8px;
      max-width:75%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Progress */
    .progress{ position:absolute; left:0; right:0; bottom:0; height:4px; background:rgba(255,255,255,.25) }
    .progress .fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--brand), var(--brand2)); transition: width .2s linear }

    /* Dots */
    .dots{display:flex; gap:6px; align-items:center}
    .dot{ width:8px; height:8px; border-radius:999px; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.6) }
    .dot.active{ background:#fff }

    /* Gallery grid */
    .gallery{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:14px
    }
    .thumb{
      position:relative;aspect-ratio:1/1;overflow:hidden;border-radius:16px;background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.08); transition: transform .08s ease, box-shadow .2s ease;
    }
    .thumb:hover{ transform: translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.15) }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  </style>
</head>
<body>
<header>
  <h1>üåü Memories Gallery</h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="wishes.html">Wishes</a>
    <a href="memories.html">Memories</a>
    <a href="quiz.html">Quiz</a>
    <a href="leaderboard.html">Leaderboard</a>
  </nav>
</header>

<section class="section">
  <div class="deck">
    <!-- Controls -->
    <div class="controls">
      <button id="playBtn" class="btn">‚ñ∂Ô∏è Play</button>
      <button id="pauseBtn" class="btn secondary" disabled>‚è∏ Pause</button>
      <button id="prevBtn" class="btn ghost" disabled>‚üµ Prev</button>
      <button id="nextBtn" class="btn ghost" disabled>Next ‚ü∂</button>
      <label class="meta">Speed:
        <select id="speedSel" class="btn ghost" style="padding:8px 10px;">
          <option value="2000">2s</option>
          <option value="3000" selected>3s</option>
          <option value="5000">5s</option>
          <option value="8000">8s</option>
        </select>
      </label>
      <button id="shuffleBtn" class="btn secondary" title="Reshuffle order" disabled>üîÄ Shuffle</button>
      <button id="fullscreenBtn" class="btn ghost" disabled>‚õ∂ Fullscreen</button>
    </div>

    <!-- Slideshow -->
    <div class="slideshow" id="slideshow">
      <img id="slideImg" class="slide-img" alt="Slideshow">
      <div id="slideCaption" class="caption">Loading photos‚Ä¶</div>

      <div class="overlay">
        <div class="bar">
          <div class="chip" id="countChip">0 photos</div>
          <div class="dots" id="dots"></div>
        </div>
      </div>

      <div class="progress"><div id="progressFill" class="fill"></div></div>
    </div>

    <!-- Grid -->
    <h2 style="text-align:center;margin-top:14px">All Photos</h2>
    <p class="meta" id="countMeta">‚Äî</p>
    <div class="gallery" id="gallery"></div>
  </div>
</section>

<footer>Made with ‚ù§Ô∏è for Riya</footer>

<script>
  // ===== Supabase config =====
  const SUPABASE_URL = "https://tbvrpaubtluwjuylduiz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidnJwYXVidGx1d2p1eWxkdWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMzAxOTUsImV4cCI6MjA3MTkwNjE5NX0.LiS7f23l9mm7Xp7xWHQH0ZM1K4rRxNrwQopqlntawcI";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const BUCKET = "photos"; // ensure Public, or switch to signed URLs

  // ===== UI refs =====
  const galleryEl = document.getElementById('gallery');
  const countMeta  = document.getElementById('countMeta');
  const slideImg   = document.getElementById('slideImg');
  const slideCaption = document.getElementById('slideCaption');
  const playBtn    = document.getElementById('playBtn');
  const pauseBtn   = document.getElementById('pauseBtn');
  const nextBtn    = document.getElementById('nextBtn');
  const prevBtn    = document.getElementById('prevBtn');
  const speedSel   = document.getElementById('speedSel');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const progressFill  = document.getElementById('progressFill');
  const countChip     = document.getElementById('countChip');
  const dotsEl        = document.getElementById('dots');
  const slideshowEl   = document.getElementById('slideshow');

  // ===== State =====
  let photos = [];           // [{url, name, path}]
  let order = [];            // randomized indices
  let idx = 0;
  let timer = null;
  let progressTimer = null;
  let progressMs = 0;

  // ===== Helpers =====
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()* (i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function enableControls(has){
    playBtn.disabled = !has;
    pauseBtn.disabled = !has;
    nextBtn.disabled = !has;
    prevBtn.disabled = !has;
    shuffleBtn.disabled = !has;
    fullscreenBtn.disabled = !has;
  }
  function setCaption(p){
    slideCaption.textContent = p ? p.name : "No photos found.";
  }
  function setCount(){
    countMeta.textContent = photos.length ? `${photos.length} photo(s)` : "No photos yet.";
    countChip.textContent = photos.length ? `${photos.length} photos` : "0 photos";
  }
  function buildDots(){
    dotsEl.innerHTML = "";
    order.forEach((_,i)=>{
      const d = document.createElement("div");
      d.className = "dot" + (i===idx?" active":"");
      d.onclick = () => { stopTimer(); idx = i; progressReset(); updateSlide(); };
      dotsEl.appendChild(d);
    });
  }
  function markDots(){
    [...dotsEl.children].forEach((d,i)=> d.classList.toggle("active", i===idx));
  }

  function progressReset(){
    progressMs = 0;
    progressFill.style.width = "0%";
  }
  function startProgress(){
    stopProgress();
    const interval = 50;
    const dur = parseInt(speedSel.value,10) || 3000;
    progressTimer = setInterval(()=>{
      progressMs += interval;
      const pct = Math.min(100, (progressMs / dur) * 100);
      progressFill.style.width = pct + "%";
      if(progressMs >= dur) progressMs = 0;
    }, interval);
  }
  function stopProgress(){ if(progressTimer){ clearInterval(progressTimer); progressTimer=null; } }

  function updateSlide(){
    if(!photos.length){ setCaption(null); slideImg.classList.remove('show'); slideImg.src = ""; return; }
    const p = photos[ order[idx] ];
    slideImg.classList.remove('show'); // crossfade
    // small delay so opacity transition restarts
    setTimeout(()=>{
      slideImg.src = p.url;
      slideImg.onload = ()=> slideImg.classList.add('show');
    }, 30);
    setCaption(p);
    markDots();
  }

  function startTimer(){
    stopTimer();
    const interval = parseInt(speedSel.value,10) || 3000;
    timer = setInterval(()=>{
      idx = (idx + 1) % order.length;
      if(idx === 0) shuffle(order); // reshuffle every loop
      progressReset();
      updateSlide();
    }, interval);
    startProgress();
  }
  function stopTimer(){ if(timer){ clearInterval(timer); timer = null; } stopProgress(); }

  // ===== Storage listing (recursive) =====
  async function listAllFiles(prefix=""){
    const out = [];
    let page = 0, perPage = 100;
    while(true){
      const { data, error } = await supa.storage.from(BUCKET).list(prefix, {
        limit: perPage, offset: page*perPage, sortBy: { column: 'name', order: 'asc' }
      });
      if(error){ console.error(error); break; }
      if(!data || data.length===0) break;

      for(const item of data){
        // Folders come with null id; recurse
        if(item.id === null && item.name){
          const sub = prefix ? `${prefix}/${item.name}` : item.name;
          const subFiles = await listAllFiles(sub);
          out.push(...subFiles);
          continue;
        }
        // File
        if(item.name){
          const nameLower = item.name.toLowerCase();
          const isImg = (item.metadata?.mimetype?.startsWith('image/')) ||
                        nameLower.match(/\.(jpg|jpeg|png|gif|webp|bmp|heic|svg)$/);
          if(isImg){
            const path = prefix ? `${prefix}/${item.name}` : item.name;
            // If bucket is public:
            const { data: pub } = supa.storage.from(BUCKET).getPublicUrl(path);
            out.push({ url: pub.publicUrl, name: item.name, path });
          }
        }
      }
      if(data.length < perPage) break;
      page++;
    }
    return out;
  }

  async function loadPhotos(){
    slideCaption.textContent = "Loading photos‚Ä¶";
    try{
      const list = await listAllFiles("");
      photos = list;
      setCount();
      renderGallery();
      if(photos.length){
        order = shuffle([...photos.keys()]);
        idx = 0;
        buildDots();
        progressReset();
        updateSlide();
        enableControls(true);
      } else {
        enableControls(false);
        setCaption(null);
      }
    }catch(err){
      console.error(err);
      slideCaption.textContent = "Failed to load photos.";
      enableControls(false);
    }
  }

  function renderGallery(){
    galleryEl.innerHTML = "";
    photos.forEach((p,i)=>{
      const div = document.createElement('div');
      div.className = 'thumb';
      div.innerHTML = `<img src="${p.url}" alt="${p.name}">`;
      div.title = p.name;
      div.onclick = ()=>{
        stopTimer();
        idx = order.indexOf(i);
        if(idx<0){ // if user clicked raw index, jump directly
          idx = i;
        }
        progressReset();
        updateSlide();
        playBtn.disabled = false; pauseBtn.disabled = true;
      };
      galleryEl.appendChild(div);
    });
  }

  // ===== Wire controls =====
  playBtn.onclick = ()=>{ startTimer(); playBtn.disabled = true; pauseBtn.disabled = false; };
  pauseBtn.onclick = ()=>{ stopTimer(); playBtn.disabled = false; pauseBtn.disabled = true; };
  nextBtn.onclick = ()=>{ stopTimer(); idx = (idx + 1) % order.length; progressReset(); updateSlide(); playBtn.disabled = false; pauseBtn.disabled = true; };
  prevBtn.onclick = ()=>{ stopTimer(); idx = (idx - 1 + order.length) % order.length; progressReset(); updateSlide(); playBtn.disabled = false; pauseBtn.disabled = true; };
  speedSel.onchange = ()=>{ if(timer){ startTimer(); } startProgress(); };
  shuffleBtn.onclick = ()=>{ shuffle(order); idx = 0; progressReset(); updateSlide(); };
  fullscreenBtn.onclick = ()=>{
    const el = document.documentElement;
    if(!document.fullscreenElement){
      (slideshowEl.requestFullscreen ? slideshowEl.requestFullscreen() : el.requestFullscreen());
    }else{
      document.exitFullscreen && document.exitFullscreen();
    }
  };

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.key === ' '){ e.preventDefault(); (timer ? pauseBtn.onclick() : playBtn.onclick()); }
    if(e.key === 'ArrowRight'){ nextBtn.onclick(); }
    if(e.key === 'ArrowLeft'){ prevBtn.onclick(); }
  });

  // ===== Kickoff =====
  loadPhotos();
</script>
</body>
</html>
