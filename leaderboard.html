<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üèÜ Riya Quiz ‚Äî Leaderboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <style>
    .wrap { max-width: 860px; margin: 18px auto; padding: 16px; }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 6px 16px rgba(0,0,0,.08); }
    .status { font-weight: 600; margin: 10px 0 0; }
    .winner { font-weight: 800; margin: 8px 0 8px; }
    table{ width:100%; border-collapse:collapse; margin-top: 10px; }
    th, td{ padding:10px; border-bottom:1px solid #eee; text-align:left; }
    th{ background:#ffe6f0; border-bottom:2px solid #ffb3cd; }
    .controls { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 10px 0 0; }
    .tiny{ color:#666; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>üèÜ Riya‚Äôs Quiz ‚Äî Leaderboard</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="wishes.html">Wishes</a>
      <a href="memories.html">Memories</a>
      <a href="quiz.html">Quiz</a>
      <a href="leaderboard.html">Leaderboard</a>
    </nav>
  </header>

  <section class="wrap">
    <div class="card">
      <h2>Live Scores</h2>
      <p class="tiny">Reveals as soon as Riya has answered all questions.</p>

      <div id="msg" class="status">Checking status‚Ä¶</div>
      <div id="winner" class="winner" style="display:none;"></div>

      <div id="board" style="display:none;">
        <table>
          <thead><tr><th>#</th><th>Name</th><th>Score</th><th>Submitted</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="controls">
          <button id="refreshBtn">üîÑ Refresh</button>
          <label class="tiny"><input type="checkbox" id="autoChk"> Auto-refresh (20s)</label>
        </div>
      </div>
    </div>
  </section>

  <footer>Made with ‚ù§Ô∏è for Riya</footer>

  <script>
    // ===== Supabase =====
    const SUPABASE_URL = "https://tbvrpaubtluwjuylduiz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidnJwYXVidGx1d2p1eWxkdWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMzAxOTUsImV4cCI6MjA3MTkwNjE5NX0.LiS7f23l9mm7Xp7xWHQH0ZM1K4rRxNrwQopqlntawcI";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // MUST match your quiz question count
    // If you change quiz questions, update this number (or compute from quizData).
    const QUESTION_COUNT = 5;

    const msg = document.getElementById('msg');
    const winnerLine = document.getElementById('winner');
    const board = document.getElementById('board');
    const tbody = document.getElementById('tbody');
    const refreshBtn = document.getElementById('refreshBtn');
    const autoChk = document.getElementById('autoChk');
    let timer = null;

    refreshBtn.onclick = render;
    autoChk.onchange = () => {
      if(autoChk.checked){ timer = setInterval(render, 20000); }
      else if(timer){ clearInterval(timer); timer = null; }
    };

    async function render(){
      try{
        msg.textContent = "Checking Riya‚Äôs answers‚Ä¶";
        winnerLine.style.display = 'none';
        winnerLine.textContent = '';
        board.style.display = 'none';
        tbody.innerHTML = "";

        // 1) Has Riya answered all questions?
        const { data: ra, error: rerr } = await supa.from('riya_answers').select('q_index, choice_index');
        if(rerr){ msg.textContent = "Error: "+rerr.message; return; }

        const need = Array.from({length: QUESTION_COUNT}, (_,i)=>i);
        const riyaMap = new Map(ra.map(r => [r.q_index, r.choice_index]));
        const missing = need.filter(i => !riyaMap.has(i));

        if(missing.length > 0){
          msg.textContent = `‚è≥ Waiting for Riya to finish (${missing.length} left: ${missing.join(', ')})‚Ä¶`;
          return;
        }

        // 2) Load participants
        msg.textContent = "Loading participants‚Ä¶";
        const { data: players, error: perr } = await supa.from('players').select('id,name,created_at');
        if(perr){ msg.textContent = "Error: "+perr.message; return; }

        if(!players || players.length === 0){
          msg.textContent = "No participants yet.";
          return;
        }

        // 3) Load player answers
        msg.textContent = "Calculating scores‚Ä¶";
        const { data: pa, error: aerr } = await supa.from('player_answers').select('player_id,q_index,choice_index,created_at');
        if(aerr){ msg.textContent = "Error: "+aerr.message; return; }

        // 4) Compute scores
        const scoreMap = new Map(players.map(p => [p.id, 0]));
        pa.forEach(a => {
          const correct = riyaMap.get(a.q_index);
          if(correct != null && a.choice_index === correct){
            scoreMap.set(a.player_id, (scoreMap.get(a.player_id)||0) + 1);
          }
        });

        const rows = players.map(p => ({
          name: p.name || "(no name)",
          score: scoreMap.get(p.id) || 0,
          time: new Date(p.created_at).getTime()
        }))
        .sort((a,b)=> b.score - a.score || a.time - b.time);

        // 5) Winner(s)
        const topScore = rows.length ? rows[0].score : 0;
        const winners = rows.filter(r => r.score === topScore).map(r => r.name);
        if(rows.length){
          winnerLine.textContent = `üèÜ Winner${winners.length>1?'s':''}: ${winners.join(', ')} ‚Äî ${topScore}/${QUESTION_COUNT}`;
          winnerLine.style.display = 'block';
        }

        // 6) Render table
        tbody.innerHTML = "";
        rows.forEach((r,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td><b>${r.score}/${QUESTION_COUNT}</b></td><td>${new Date(r.time).toLocaleString()}</td>`;
          tbody.appendChild(tr);
        });

        msg.textContent = "‚úÖ Scores are live.";
        board.style.display = 'block';
      }catch(err){
        console.error(err);
        msg.textContent = "Unexpected error. Check console.";
      }
    }

    render();
  </script>
</body>
</html>
