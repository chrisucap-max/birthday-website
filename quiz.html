<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéÆ Riya Quiz</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .quiz-wrap{ max-width: 760px; margin: 18px auto; padding: 16px; }
    .quiz-hero{ margin: 0 auto 12px; padding: 14px 16px; background: #fff; border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .quiz-hero h2{ margin: 8px 0 4px; font-size: clamp(22px, 5vw, 36px); }
    .quiz-box{ background:#fff; border-radius: 14px; padding: 16px; box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .quiz-q{ font-size: 18px; font-weight: 700; margin: 6px 0 12px; }
    .quiz-option{ display:block; width:100%; text-align:left; margin:8px 0; padding:12px 14px; background:#ffe6f0; border:2px solid #ff4081; border-radius:10px; cursor:pointer; }
    .quiz-option.correct{ background:#c2f7c2; border-color:#2ecc71; }
    .quiz-option.wrong{ background:#f9c0c0; border-color:#e74c3c; }
    .quiz-cta{ display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
    .btn{ background:#ff4081; color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; text-decoration:none; }
    .btn.secondary{ background:#6c63ff; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .quiz-result{ text-align:center; font-size:20px; font-weight:800; margin:12px 0 4px; }
    .tiny{ color:#666; font-size:12px; }
    .leader{ margin-top:16px; background:#fff; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.08); padding:12px 14px; }
    .leader h3{ margin:6px 0 8px; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:8px; border-bottom:1px solid #eee; text-align:left; }
  </style>
</head>
<body>
  <header>
    <h1>üéâ Riya‚Äôs Birthday</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="wishes.html">Wishes</a>
      <a href="memories.html">Memories</a>
      <a href="quiz.html">Quiz</a>
    </nav>
  </header>

  <section class="quiz-wrap">
    <div class="quiz-hero">
      <h2>üéÆ How Well Do You Know Riya?</h2>
      <p class="tiny">Answer, get saved to the scoreboard, and the winner is revealed once Riya submits her answers on her birthday (Sept 2)!</p>
    </div>

    <!-- Player register -->
    <div class="quiz-box" id="regBox">
      <p class="quiz-q">Your Name</p>
      <input id="playerName" placeholder="e.g., Anya" style="padding:10px 12px; border:2px solid #ddd; border-radius:8px; width:100%; max-width:360px">
      <div class="quiz-cta">
        <button id="startBtn" class="btn">Start Quiz ‚û°Ô∏è</button>
      </div>
    </div>

    <!-- Quiz -->
    <div class="quiz-box" id="playBox" style="display:none;">
      <div id="progress" class="tiny">Question 1 / 5</div>
      <div class="quiz-q" id="quizQ">Loading‚Ä¶</div>
      <div id="quizOpts"></div>
      <div class="quiz-cta">
        <button id="nextBtn" class="btn" disabled>Next ‚û°Ô∏è</button>
      </div>
      <div id="quizStatus" class="tiny"></div>
    </div>

    <!-- After submit -->
    <div class="quiz-box" id="doneBox" style="display:none;">
      <div class="quiz-result" id="quizResult"></div>
      <p class="tiny" id="revealMsg"></p>
      <div id="leaderWrap" class="leader" style="display:none;">
        <h3>üèÜ Leaderboard</h3>
        <table id="leaderTable">
          <thead><tr><th>#</th><th>Name</th><th>Score</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="quiz-cta">
        <button id="playAgain" class="btn secondary">üîÅ Play Again</button>
      </div>
    </div>
  </section>

  <footer>Made with ‚ù§Ô∏è for Riya</footer>

  <script>
    // Supabase
    const SUPABASE_URL = "https://tbvrpaubtluwjuylduiz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidnJwYXVidGx1d2p1eWxkdWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMzAxOTUsImV4cCI6MjA3MTkwNjE5NX0.LiS7f23l9mm7Xp7xWHQH0ZM1K4rRxNrwQopqlntawcI";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Config
    const REVEAL_DATE_ISO = "2025-09-02T00:00:00+05:30"; // IST midnight; adjust if you want ET

    // Quiz content (must match what Riya will answer in riya.html)
    const quizData = [
      { q: "üíñ Who is Riya‚Äôs celebrity crush?", opts: ["Chris Hemsworth","Chris Evans","Shah Rukh Khan","Harry Styles"] },
      { q: "üç´ What sweet does Riya absolutely love?", opts: ["Ferrero Rocher","Kinder Joy","Laddu","Brownies"] },
      { q: "üå∏ How would you best describe Riya?", opts: ["Joyful","Serious","Sleepy","Grumpy"] },
      { q: "üéÇ When is Riya‚Äôs birthday?", opts: ["Aug 15","Sep 2","Oct 10","Jan 1"] },
      { q: "üé¨ What kind of movies does Riya vibe with most?", opts: ["Action","Rom-com","Horror","Documentary"] }
    ];

    // State
    let playerId = null, playerName = "", idx = 0, locked = false;
    let answers = new Array(quizData.length).fill(null);

    // Elements
    const regBox = document.getElementById("regBox");
    const playBox = document.getElementById("playBox");
    const doneBox = document.getElementById("doneBox");

    const progressEl = document.getElementById("progress");
    const qEl = document.getElementById("quizQ");
    const optEl = document.getElementById("quizOpts");
    const nextBtn = document.getElementById("nextBtn");
    const resultEl = document.getElementById("quizResult");
    const revealMsg = document.getElementById("revealMsg");
    const leaderWrap = document.getElementById("leaderWrap");
    const leaderTable = document.querySelector("#leaderTable tbody");

    document.getElementById("startBtn").onclick = startQuiz;
    document.getElementById("playAgain").onclick = () => location.reload();

    async function startQuiz(){
      const input = document.getElementById("playerName");
      playerName = (input.value || "").trim();
      if(!playerName){ alert("Please enter your name."); return; }

      // Create player row
      const { data, error } = await supa.from("players").insert([{ name: playerName }]).select().single();
      if(error){ alert("Could not start: " + error.message); return; }
      playerId = data.id;

      regBox.style.display = "none";
      playBox.style.display = "block";
      idx = 0; answers.fill(null);
      loadQ();
    }

    function updateProgress(){ progressEl.textContent = `Question ${idx+1} / ${quizData.length}`; }

    function loadQ(){
      locked = false;
      nextBtn.disabled = true;
      const item = quizData[idx];
      updateProgress();
      qEl.textContent = item.q;
      optEl.innerHTML = "";
      item.opts.forEach((o, i) => {
        const btn = document.createElement("button");
        btn.textContent = o;
        btn.className = "quiz-option";
        btn.onclick = () => choose(i, btn);
        optEl.appendChild(btn);
      });
    }

    async function choose(i, btn){
      if(locked) return;
      locked = true;
      answers[idx] = i;

      // Save per-question answer (upsert via insert on PK conflict not available client-side; we just insert primary-key unique)
      const { error } = await supa.from("player_answers").insert([{ player_id: playerId, q_index: idx, choice_index: i }]);
      if(error && !error.message.includes("duplicate key")){ console.error(error); alert("Save failed: " + error.message); }

      // Visual feedback
      const all = optEl.querySelectorAll(".quiz-option");
      all.forEach(b => b.disabled = true);
      btn.classList.add("correct"); // we don't know correct yet; just highlight choice
      nextBtn.disabled = false;
    }

    nextBtn.onclick = async () => {
      idx++;
      if(idx < quizData.length){ loadQ(); }
      else{
        playBox.style.display = "none";
        doneBox.style.display = "block";
        resultEl.textContent = `Thanks, ${playerName}! Your answers are saved. üéâ`;
        await maybeShowLeaderboard();
      }
    };

    async function maybeShowLeaderboard(){
      // Check if reveal date passed AND Riya has answered ALL
      const revealPassed = new Date() >= new Date(REVEAL_DATE_ISO);

      // Count Riya answers
      const { data: ra, error: rerr } = await supa.from("riya_answers").select("q_index, choice_index");
      if(rerr){ console.error(rerr); revealMsg.textContent = "Could not check Riya's answers yet."; return; }

      const riyaMap = new Map(ra.map(r => [r.q_index, r.choice_index]));
      const allAnsweredByRiya = quizData.every((_, i) => riyaMap.has(i));

      if(!revealPassed || !allAnsweredByRiya){
        const missing = quizData.filter((_, i)=>!riyaMap.has(i)).length;
        revealMsg.textContent = `‚è≥ Scores reveal on Riya‚Äôs birthday once she answers all questions! Missing from Riya: ${missing}`;
        leaderWrap.style.display = "none";
        return;
      }

      // Build scores by comparing each player's answers to Riya's
      const { data: players, error: perr } = await supa.from("players").select("id,name,created_at");
      if(perr){ console.error(perr); return; }

      const { data: allpa, error: aerr } = await supa.from("player_answers")
        .select("player_id,q_index,choice_index");
      if(aerr){ console.error(aerr); return; }

      const scoreMap = new Map(); // player_id -> score
      players.forEach(p => scoreMap.set(p.id, 0));
      allpa.forEach(a => {
        const correct = riyaMap.get(a.q_index);
        if(correct != null && a.choice_index === correct){
          scoreMap.set(a.player_id, (scoreMap.get(a.player_id)||0)+1);
        }
      });

      // Make leaderboard
      const rows = players.map(p => ({
        name: p.name,
        score: scoreMap.get(p.id)||0,
        time: new Date(p.created_at).getTime()
      }))
      .sort((a,b)=> b.score - a.score || a.time - b.time); // higher score wins; earlier submit wins tie

      // Render table
      leaderTable.innerHTML = "";
      rows.forEach((r,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.score}/${quizData.length}</td>`;
        leaderTable.appendChild(tr);
      });

      // Announce winner(s)
      const topScore = rows.length ? rows[0].score : 0;
      const winners = rows.filter(r => r.score === topScore).map(r=>r.name);
      revealMsg.textContent = `üèÜ Winner${winners.length>1?'s':''}: ${winners.join(', ')} with ${topScore}/${quizData.length}!`;
      leaderWrap.style.display = "block";
    }
  </script>
</body>
</html>
